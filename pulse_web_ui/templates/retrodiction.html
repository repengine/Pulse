{% extends "base.html" %}

{% block title %}Retrodiction - Pulse UI{% endblock %}

{% block header %}Retrodiction Analysis{% endblock %}

{% block content %}
<div class="controls-area">
    <label for="run-selector">Select Retrodiction Run:</label>
    <!-- Trigger loadRunData when the selection changes -->
    <select id="run-selector" name="run_id" onchange="loadRunData()">
        {% if runs %}
            {% for run in runs %}
                <option value="{{ run.id }}">{{ run.name }} ({{ run.timestamp }})</option>
            {% endfor %}
        {% else %}
            <option value="">No runs available</option>
        {% endif %}
    </select>
    <!-- Removed the redundant Load button -->
</div>

<hr>

<div class="controls-area" style="margin-top: 15px;"> <!-- Added margin for spacing -->
    <button id="compare-nvda-btn" class="btn btn-primary">Compare NVDA Retrodiction</button>
</div>
<div class="results-area">
    <h2>Results for Selected Run</h2>

    <div id="retro-summary" class="result-section">
        <h3>Summary Metrics</h3>
        <p><i>Select a run to view summary metrics.</i></p>
        <!-- Placeholder for definition list -->
    </div>

    <div id="retro-insights" class="result-section">
        <h3>Derived Insights</h3>
        <p><i>Select a run to view insights.</i></p>
        <!-- Placeholder for text content -->
    </div>

    <div id="retro-charts" class="result-section">
        <h3>Visualizations</h3>
        <p><i>Select a run to view charts.</i></p>
        <!-- Placeholder for chart elements -->
        <div id="plotly-chart-div"></div> <!-- Ensure this div exists for Plotly -->
    </div>

    <div id="retro-data-table" class="result-section">
        <h3>Detailed Data</h3>
        <p><i>Select a run to view detailed data.</i></p>
        <!-- Placeholder for data table -->
    </div>
</div>

    <div id="nvda-comparison-section" class="result-section">
        <h3>NVDA Comparison</h3>
        <div id="nvda-comparison-chart" style="min-height: 300px;">
            <!-- Plotly chart will be rendered here -->
            <p><i>Click "Compare NVDA Retrodiction" to load data.</i></p>
        </div>
        <div id="nvda-accuracy-display" style="margin-top: 15px;">
            <p><i>Accuracy metrics will appear here.</i></p>
        </div>
    </div>

<style>
    .controls-area {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: flex; /* Align items nicely */
        align-items: center;
    }
    .controls-area label {
        margin-right: 10px;
        font-weight: bold;
    }
    .controls-area select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 3px;
        flex-grow: 1; /* Allow select to take available space */
    }
    .results-area {
        margin-top: 20px;
    }
    .result-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #fff;
    }
    .result-section h3 {
        margin-top: 0;
        color: #34495e;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    .result-section p i, .result-section dl i { /* Style initial italic text */
        color: #777;
    }
    /* Styling for summary metrics definition list */
    #retro-summary dl {
        margin-top: 10px;
    }
    #retro-summary dt {
        font-weight: bold;
        color: #555;
        float: left;
        width: 150px; /* Adjust as needed */
        clear: left;
        margin-bottom: 5px;
    }
    #retro-summary dd {
        margin-left: 160px; /* Should be > dt width */
        margin-bottom: 5px;
    }
    /* Basic table styling */
    #retro-data-table table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    #retro-data-table th, #retro-data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    #retro-data-table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    /* Ensure chart div takes space */
    #plotly-chart-div {
        min-height: 300px; /* Give it some default height */
    }
</style>

<!-- Include Plotly.js library (already present, good) -->
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

<script>
    function loadRunData() {
        const runSelector = document.getElementById('run-selector');
        const selectedRunId = runSelector.value;
        const summaryDiv = document.getElementById('retro-summary');
        const insightsDiv = document.getElementById('retro-insights');
        const chartsDiv = document.getElementById('retro-charts'); // Container for title + chart div
        const chartPlotDiv = document.getElementById('plotly-chart-div'); // Specific div for plotting
        const dataTableDiv = document.getElementById('retro-data-table');

        // Clear previous results and show loading state
        summaryDiv.innerHTML = '<h3>Summary Metrics</h3><p><i>Loading...</i></p>';
        insightsDiv.innerHTML = '<h3>Derived Insights</h3><p><i>Loading...</i></p>';
        // Clear only the plot div, keep the title
        chartPlotDiv.innerHTML = '<p><i>Loading...</i></p>';
        dataTableDiv.innerHTML = '<h3>Detailed Data</h3><p><i>Loading...</i></p>';

        if (!selectedRunId) {
            // If "No runs available" or similar is selected, reset to initial state
            summaryDiv.innerHTML = '<h3>Summary Metrics</h3><p><i>Select a run to view summary metrics.</i></p>';
            insightsDiv.innerHTML = '<h3>Derived Insights</h3><p><i>Select a run to view insights.</i></p>';
            chartPlotDiv.innerHTML = ''; // Clear plot area
            dataTableDiv.innerHTML = '<h3>Detailed Data</h3><p><i>Select a run to view detailed data.</i></p>';
            // Optional: Could display a message like "Please select a valid run."
            return;
        }

        // Fetch data from the API
        fetch(`/api/retrodiction_data/${selectedRunId}`)
            .then(response => {
                if (!response.ok) {
                    // Try to get error message from response body if possible
                    return response.text().then(text => {
                        throw new Error(`HTTP error ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update Summary Metrics using Definition List (dl)
                let summaryHtml = '<h3>Summary Metrics</h3>';
                if (data.summary_metrics && Object.keys(data.summary_metrics).length > 0) {
                    summaryHtml += '<dl>';
                    for (const [key, value] of Object.entries(data.summary_metrics)) {
                        // Capitalize key nicely
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        summaryHtml += `<dt>${formattedKey}:</dt><dd>${value !== null && value !== undefined ? value : 'N/A'}</dd>`;
                    }
                    summaryHtml += '</dl>';
                } else {
                    summaryHtml += '<p><i>No summary metrics available.</i></p>';
                }
                summaryDiv.innerHTML = summaryHtml;

                // Update Insights
                insightsDiv.innerHTML = `<h3>Derived Insights</h3><p>${data.insights || '<i>No insights available.</i>'}</p>`;

                // Update Charts using Plotly.js
                chartPlotDiv.innerHTML = ''; // Clear loading message
                if (data.chart_json) {
                    try {
                        const figure = JSON.parse(data.chart_json); // Parse the JSON string
                        Plotly.newPlot(chartPlotDiv, figure.data, figure.layout || {}); // Use empty layout if null
                    } catch (e) {
                        console.error("Error parsing or plotting chart JSON:", e);
                        chartPlotDiv.innerHTML = '<p><i>Error rendering chart. Check console for details.</i></p>';
                    }
                } else {
                    chartPlotDiv.innerHTML = '<p><i>No chart data available for this run.</i></p>';
                }

                // Update Data Table
                let tableHtml = '<h3>Detailed Data</h3>';
                if (data.detailed_data && Array.isArray(data.detailed_data) && data.detailed_data.length > 0) {
                    tableHtml += '<table><thead><tr>';
                    // Create headers from keys of the first object
                    const headers = Object.keys(data.detailed_data[0]);
                    headers.forEach(key => {
                         const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        tableHtml += `<th>${formattedKey}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    // Create rows
                    data.detailed_data.forEach(row => {
                        tableHtml += '<tr>';
                        headers.forEach(header => {
                            // Access value using the header key, handle missing values
                            const value = row[header];
                            tableHtml += `<td>${value !== null && value !== undefined ? value : 'N/A'}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                } else {
                    tableHtml += '<p><i>No detailed data available.</i></p>';
                }
                dataTableDiv.innerHTML = tableHtml;

            })
            .catch(error => {
                console.error('Error fetching or processing retrodiction data:', error);
                const errorMsg = `<p><i>Error loading data: ${error.message}. Check console for details.</i></p>`;
                summaryDiv.innerHTML = `<h3>Summary Metrics</h3>${errorMsg}`;
                insightsDiv.innerHTML = `<h3>Derived Insights</h3>${errorMsg}`;
                chartPlotDiv.innerHTML = errorMsg; // Error in the plot div
                dataTableDiv.innerHTML = `<h3>Detailed Data</h3>${errorMsg}`;
            });
    }
// --- NVDA Comparison Logic ---
    const nvdaButton = document.getElementById('compare-nvda-btn');
    const nvdaChartDiv = document.getElementById('nvda-comparison-chart');
    const nvdaAccuracyDiv = document.getElementById('nvda-accuracy-display');

    if (nvdaButton && nvdaChartDiv && nvdaAccuracyDiv) {
        nvdaButton.addEventListener('click', () => {
            console.log("Compare NVDA button clicked."); // Debug log
            nvdaChartDiv.innerHTML = '<p><i>Loading NVDA comparison data...</i></p>';
            nvdaAccuracyDiv.innerHTML = '<p><i>Loading...</i></p>';

            fetch('/api/retrodiction/compare/nvidia_stock')
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error ${response.status}: ${text || response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received NVDA comparison data:", data); // Debug log

                    // Validate all required fields from the API response
                    if (!data.historical_timestamps || !data.historical_values || !data.retrodictive_values || !data.accuracy_metrics) {
                        console.error("API response missing required data fields:", data); // Log the problematic data
                        throw new Error("API response missing required data fields (timestamps, values, metrics).");
                    }

                    // Create trace for historical data
                    const historicalTrace = {
                        x: data.historical_timestamps,
                        y: data.historical_values,
                        mode: 'lines',
                        name: 'Historical NVDA', // Updated name
                        line: {color: '#1f77b4'} // Blue
                    };

                    // Create trace for retrodictive data
                    const retrodictiveTrace = {
                        x: data.historical_timestamps, // Use the same timestamps
                        y: data.retrodictive_values,
                        mode: 'lines',
                        name: 'PULSE Retrodiction', // Updated name
                        line: {color: '#ff7f0e'} // Orange
                    };

                    // Update chart layout
                    const layout = {
                        title: 'NVDA: Historical vs. PULSE Retrodiction', // Updated title
                        xaxis: { title: 'Date' },
                        yaxis: { title: 'Price' },
                        margin: { t: 40, l: 50, r: 50, b: 50 }, // Adjusted top margin for title
                        showlegend: true // Ensure legend is displayed
                    };

                    // Plot both traces
                    Plotly.newPlot(nvdaChartDiv, [historicalTrace, retrodictiveTrace], layout);

                    // Display accuracy metrics
                    const mae = data.accuracy_metrics.mae;
                    const rmse = data.accuracy_metrics.rmse;
                    const formattedMae = (typeof mae === 'number') ? mae.toFixed(3) : 'N/A';
                    const formattedRmse = (typeof rmse === 'number') ? rmse.toFixed(3) : 'N/A';

                    nvdaAccuracyDiv.innerHTML = `<p><b>Accuracy Metrics:</b> MAE: ${formattedMae}, RMSE: ${formattedRmse}</p>`;

                })
                .catch(error => {
                    console.error('Error fetching or processing NVDA comparison data:', error);
                    const errorMsg = `<p style="color: red;"><i>Error loading NVDA comparison: ${error.message}. Check console.</i></p>`;
                    nvdaChartDiv.innerHTML = errorMsg; // Show error in chart div
                    nvdaAccuracyDiv.innerHTML = ''; // Clear accuracy div on error
                });
        });
    } else {
        console.error("Could not find NVDA comparison elements (button, chart div, or accuracy div).");
    }
    // --- End NVDA Comparison Logic ---

    // Load data for the initially selected run when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        const runSelector = document.getElementById('run-selector');
        // Check if there's a valid selection (not the "No runs" option)
        if (runSelector && runSelector.value) {
            loadRunData();
        } else {
             // Set initial placeholder text if no runs are loaded initially
            document.getElementById('retro-summary').innerHTML = '<h3>Summary Metrics</h3><p><i>Select a run to view summary metrics.</i></p>';
            document.getElementById('retro-insights').innerHTML = '<h3>Derived Insights</h3><p><i>Select a run to view insights.</i></p>';
            document.getElementById('plotly-chart-div').innerHTML = ''; // Clear plot area
            document.getElementById('retro-data-table').innerHTML = '<h3>Detailed Data</h3><p><i>Select a run to view detailed data.</i></p>';
        }
    });
</script>
{% endblock %}