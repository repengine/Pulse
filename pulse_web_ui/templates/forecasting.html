{% extends "base.html" %}

{% block title %}Forecasting - Pulse UI{% endblock %}

{% block header %}Forecast Viewer{% endblock %}

{% block content %}
<div class="controls-area">
    <label for="set-selector">Select Forecast Set or Variable:</label>
    <!-- Trigger loadForecastData when the selection changes -->
    <select id="set-selector" name="forecast_selection" onchange="loadForecastData()">
        <option value="nvda">NVDA Forecast</option> {# Added NVDA option #}
        {% if forecast_sets %}
            {% for f_set in forecast_sets %}
                <option value="{{ f_set.id }}">{{ f_set.name }} ({{ f_set.timestamp }})</option>
            {% endfor %}
        {% else %}
            {# Keep this option only if forecast_sets might be empty but NVDA is still an option #}
            {# <option value="">No forecast sets available</option> #}
        {% endif %}
    </select>
    <!-- Removed the Load button -->
</div>

<hr>

<div class="results-area">
    <h2>Forecast Details</h2>

    <div id="forecast-chart" class="result-section">
        <h3>Forecast Chart</h3>
        <div id="plotly-forecast-chart-div"><p><i>Select a forecast set to view the chart.</i></p></div>
    </div>

    <div id="forecast-metrics" class="result-section">
        <h3>Probabilistic Metrics</h3>
        <p><i>Select a forecast set to view metrics.</i></p>
        <!-- Placeholder for definition list -->
    </div>

</div>

<!-- Re-use styles from retrodiction.html or move to style.css later -->
<style>
    .controls-area {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: flex; /* Align items nicely */
        align-items: center;
    }
    .controls-area label {
        margin-right: 10px;
        font-weight: bold;
    }
    .controls-area select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 3px;
        flex-grow: 1; /* Allow select to take available space */
    }
    .results-area {
        margin-top: 20px;
    }
    .result-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #fff;
    }
    .result-section h3 {
        margin-top: 0;
        color: #34495e;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    .result-section p i, .result-section dl i { /* Style initial italic text */
        color: #777;
    }
    #plotly-forecast-chart-div {
        min-height: 300px; /* Ensure space for chart */
    }
    /* Styling for metrics definition list */
    #forecast-metrics dl {
        margin-top: 10px;
    }
    #forecast-metrics dt {
        font-weight: bold;
        color: #555;
        float: left;
        width: 180px; /* Adjust as needed */
        clear: left;
        margin-bottom: 5px;
    }
    #forecast-metrics dd {
        margin-left: 190px; /* Should be > dt width */
        margin-bottom: 5px;
    }
</style>

<!-- Include Plotly.js library -->
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

<script>
    function loadForecastData() {
        const selector = document.getElementById('set-selector');
        const selectedValue = selector.value;
        const chartDiv = document.getElementById('plotly-forecast-chart-div');
        const metricsDiv = document.getElementById('forecast-metrics');

        // Clear previous results and show loading state
        chartDiv.innerHTML = '<p><i>Loading chart...</i></p>';
        metricsDiv.innerHTML = '<h3>Probabilistic Metrics</h3><p><i>Loading metrics...</i></p>';

        if (!selectedValue) {
            // Handle case where nothing is selected (e.g., if placeholder option exists)
            chartDiv.innerHTML = '<p><i>Select a forecast set or variable to view the chart.</i></p>';
            metricsDiv.innerHTML = '<h3>Probabilistic Metrics</h3><p><i>Select a forecast set or variable to view metrics.</i></p>';
            return;
        }

        let apiUrl;
        let isVariableForecast = false;

        if (selectedValue === 'nvda') {
            apiUrl = `/api/forecast_data/variable/nvda`;
            isVariableForecast = true;
        } else {
            // Assume it's a forecast set ID
            apiUrl = `/api/forecast_data/${selectedValue}`;
        }

        // Fetch data from the determined API endpoint
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // --- Update Metrics ---
                if (isVariableForecast) {
                    // Specific handling for variable forecast (NVDA) - no metrics expected
                    metricsDiv.innerHTML = '<h3>Probabilistic Metrics</h3><p><i>Metrics are not available for individual variable forecasts.</i></p>';
                } else {
                    // Original handling for forecast sets
                    let metricsHtml = '<h3>Probabilistic Metrics</h3>';
                    if (data.metrics && Object.keys(data.metrics).length > 0) {
                        metricsHtml += '<dl>';
                        for (const [key, value] of Object.entries(data.metrics)) {
                            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            const formattedValue = (typeof value === 'number') ? value.toFixed(4) : (value !== null && value !== undefined ? value : 'N/A');
                            metricsHtml += `<dt>${formattedKey}:</dt><dd>${formattedValue}</dd>`;
                        }
                        metricsHtml += '</dl>';
                    } else {
                        metricsHtml += '<p><i>No metrics available for this set.</i></p>';
                    }
                    metricsDiv.innerHTML = metricsHtml;
                }

                // --- Update Chart (Common Logic) ---
                chartDiv.innerHTML = ''; // Clear loading message
                if (data.chart_json) {
                    try {
                        // The variable endpoint returns JSON directly, the set endpoint returns a stringified JSON
                        // Let's try parsing only if it's a string, otherwise assume it's already an object
                        let figure;
                        if (typeof data.chart_json === 'string') {
                             figure = JSON.parse(data.chart_json);
                        } else if (typeof data.chart_json === 'object' && data.chart_json !== null) {
                             figure = data.chart_json; // Assume it's already parsed (like from the variable endpoint)
                        } else {
                            throw new Error("chart_json is not in a valid format (string or object).");
                        }
                        Plotly.newPlot(chartDiv, figure.data, figure.layout || {});
                    } catch (e) {
                        console.error("Error parsing or plotting chart JSON:", e);
                        chartDiv.innerHTML = `<p><i>Error rendering chart: ${e.message}. Check console for details.</i></p>`;
                    }
                } else {
                    chartDiv.innerHTML = '<p><i>No chart data available for this selection.</i></p>';
                }
            })
            .catch(error => {
                console.error('Error fetching or processing forecast data:', error);
                const errorMsg = `<p><i>Error loading data: ${error.message}. Check console for details.</i></p>`;
                chartDiv.innerHTML = errorMsg;
                metricsDiv.innerHTML = `<h3>Probabilistic Metrics</h3>${errorMsg}`;
            });
    }

    // Load data for the initially selected item when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('set-selector');
        // Check if there's a valid selection
        if (selector && selector.value) {
            loadForecastData(); // Load data for whatever is selected initially (could be NVDA or a set)
        } else {
             // Ensure initial placeholder text is set if nothing is selected initially
            document.getElementById('plotly-forecast-chart-div').innerHTML = '<p><i>Select a forecast set or variable to view the chart.</i></p>';
            document.getElementById('forecast-metrics').innerHTML = '<h3>Probabilistic Metrics</h3><p><i>Select a forecast set or variable to view metrics.</i></p>';
        }
    });
</script>
{% endblock %}
