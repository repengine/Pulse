# Module Analysis: `data/ground_truth_ingestion_manager.py`

## 1. Module Intent/Purpose

The [`data/ground_truth_ingestion_manager.py`](data/ground_truth_ingestion_manager.py:1) module is designed as a comprehensive solution for managing the ingestion of ground truth financial data. Its core purpose is to ensure that all variables defined in Pulse's `VARIABLE_REGISTRY` are correctly mapped to reliable data sources and that this data is kept up-to-date through scheduled updates. It aims to provide a robust, automated system for maintaining a historical dataset (targeting 3 years of data) for AI model training and backtesting.

## 2. Key Functionalities

*   **Enhanced Variable Mapping:**
    *   Implements an [`generate_enhanced_mappings()`](data/ground_truth_ingestion_manager.py:190) function to map all variables from `VARIABLE_REGISTRY` (or a fallback) to appropriate data sources (FRED, World Bank, Alpha Vantage, Finnhub, NASDAQ).
    *   Uses pattern matching (regex), explicit source tags in variable descriptions, and type-based fallbacks for comprehensive coverage.
    *   Saves these mappings to [`data/ground_truth_dataset/variable_mappings.json`](data/ground_truth_dataset/variable_mappings.json).
*   **Data Fetching & Storage:**
    *   Reuses data fetching logic similar to [`data/ground_truth_generator.py`](data/ground_truth_generator.py:1) for various APIs.
    *   Fetches economic data and market data, storing them in [`data/ground_truth_dataset/economic_indicators.csv`](data/ground_truth_dataset/economic_indicators.csv) and [`data/ground_truth_dataset/market_data.csv`](data/ground_truth_dataset/market_data.csv) respectively.
    *   Merges new data with existing data in the CSV files, avoiding duplicates.
*   **API Management:**
    *   Retrieves API keys from environment variables.
    *   Implements rate limiting ([`rate_limit()`](data/ground_truth_ingestion_manager.py:615)) and exponential backoff for API calls.
    *   Tracks API call costs ([`track_cost()`](data/ground_truth_ingestion_manager.py:630)) against a configurable budget, storing tracking info in [`data/ground_truth_dataset/budget_tracking.json`](data/ground_truth_dataset/budget_tracking.json).
*   **Scheduling & Daemonization (if `apscheduler` is available):**
    *   Uses `apscheduler` to schedule regular data updates:
        *   Daily updates for market data ([`update_market_data()`](data/ground_truth_ingestion_manager.py:1543)).
        *   Monthly updates for economic data ([`update_economic_data()`](data/ground_truth_ingestion_manager.py:1590)).
        *   Daily updates for metadata ([`update_metadata()`](data/ground_truth_ingestion_manager.py:1637)).
        *   Hourly error monitoring ([`error_monitor_job()`](data/ground_truth_ingestion_manager.py:1664)).
    *   Provides CLI commands to `start`, `stop`, and check `status` of the daemon process.
    *   Manages a PID file ([`data/ground_truth_dataset/ingestion_manager.pid`](data/ground_truth_dataset/ingestion_manager.pid)) for daemon control.
    *   Saves and restores scheduler state using `pickle` ([`data/ground_truth_dataset/scheduler_state.pkl`](data/ground_truth_dataset/scheduler_state.pkl)).
*   **Logging & Error Reporting:**
    *   Main process logging to [`data/ground_truth_dataset/logs/ground_truth_ingestion_manager.log`](data/ground_truth_dataset/logs/ground_truth_ingestion_manager.log).
    *   Logs variables that cannot be mapped to [`data/ground_truth_dataset/logs/unmapped_variables.log`](data/ground_truth_dataset/logs/unmapped_variables.log).
    *   Logs variables for which data fetching failed to [`data/ground_truth_dataset/logs/error_variables.log`](data/ground_truth_dataset/logs/error_variables.log).
*   **Documentation & Metadata:**
    *   Generates/updates [`data/ground_truth_dataset/metadata.json`](data/ground_truth_dataset/metadata.json) with detailed dataset information, including coverage statistics and API usage.
    *   Generates/updates [`data/ground_truth_dataset/README.md`](data/ground_truth_dataset/README.md).
*   **Command-Line Interface (CLI):**
    *   `start`: Starts the daemon.
    *   `stop`: Stops the daemon.
    *   `status`: Checks daemon status, including job schedule and budget.
    *   `force-update`: Triggers an immediate data update with options to specify sources, variables, date range, budget, and skip certain data types.
*   **Initial Setup:** A [`run_initial_setup()`](data/ground_truth_ingestion_manager.py:2002) function ensures necessary directories and basic files (mappings, budget tracking, README) are created if they don't exist.

## 3. Role Within `data/` Directory

This module acts as an advanced, automated manager for the ground truth dataset generated by (or in conjunction with) [`data/ground_truth_generator.py`](data/ground_truth_generator.py:1). While the generator focuses on the one-time or manual creation of the dataset, the ingestion manager aims to keep this dataset continuously updated, ensure comprehensive variable coverage, and provide robust operational management (daemonization, logging, error tracking). It is the primary orchestrator for maintaining the freshness and completeness of the data in `data/ground_truth_dataset/`.

## 4. Dependencies

### External Libraries:
*   `os`
*   `sys`
*   `json`
*   `time`
*   `signal`
*   `logging`
*   `argparse`
*   `requests`
*   `pandas`
*   `platform`
*   `subprocess`
*   `threading` (implicitly, as `apscheduler.schedulers.background` uses it)
*   `datetime` (from `datetime` module)
*   `Path` (from `pathlib` module)
*   `typing` (Dict, List, Any, Optional, Set, Tuple, Union, cast)
*   `atexit`
*   `re`
*   `pickle`
*   `copy`
*   `apscheduler` (optional, required for daemon mode and scheduling)

### Internal Pulse Modules:
*   [`core.variable_registry`](core/variable_registry.py:0) (optional): Imports `VARIABLE_REGISTRY`. Uses a hardcoded fallback if unavailable.

## 5. SPARC Principles Adherence

*   **Module Intent/Purpose:**
    *   **Clarity:** The intent is very clear: to be a robust, automated manager for ground truth data ingestion, ensuring completeness and timeliness.
    *   **Adherence:** High. The module is focused on this management and automation task.

*   **Operational Status/Completeness:**
    *   **Status:** Appears largely complete and operational, especially if `apscheduler` is available.
    *   **Details:** It includes comprehensive variable mapping, data fetching, scheduling, daemonization, logging, and CLI controls. The fallback mechanisms for `VARIABLE_REGISTRY` and API keys enhance robustness.

*   **Implementation Gaps / Unfinished Next Steps:**
    *   **NASDAQ API Integration:** Similar to [`data/ground_truth_generator.py`](data/ground_truth_generator.py:1), the actual NASDAQ API fetching is marked as "TODO" ([`data/ground_truth_ingestion_manager.py:1105`](data/ground_truth_ingestion_manager.py:1105)).
    *   **Scheduler State Restoration:** While [`save_scheduler_state()`](data/ground_truth_ingestion_manager.py:1896) exists, the actual logic in [`restore_scheduler_state()`](data/ground_truth_ingestion_manager.py:1920) only logs restoration but doesn't seem to re-apply the jobs to a new scheduler instance if it were to be restarted. The scheduler is typically re-initialized fresh in [`setup_scheduler()`](data/ground_truth_ingestion_manager.py:1477).
    *   **Windows Daemon Management:** The `is_process_running` and `stop_daemon` functions have platform-specific logic for Windows (`tasklist`, `taskkill`) which is good, but thorough testing on Windows for daemon stability would be needed.
    *   **Configuration:** API costs, limits, and default budget are hardcoded. Externalizing these to a configuration file would be beneficial.

*   **Connections & Dependencies:**
    *   **External APIs:** Same as `ground_truth_generator.py` (FRED, World Bank, Alpha Vantage, Finnhub, intended NASDAQ).
    *   **Environment Variables:** Relies on `ALPHA_VANTAGE_KEY`, `FINNHUB_KEY`, `FRED_KEY`, `NASDAQ_KEY`.
    *   **File System:**
        *   Reads/Writes: PID file, scheduler state file, variable mappings JSON, budget tracking JSON.
        *   Writes: Output CSVs (`economic_indicators.csv`, `market_data.csv`), metadata JSON, README, and multiple log files within `data/ground_truth_dataset/`.
    *   **Internal Modules:** Optionally depends on [`core.variable_registry`](core/variable_registry.py:0).

*   **Function and Class Example Usages:**
    *   **Mapping:** [`generate_enhanced_mappings()`](data/ground_truth_ingestion_manager.py:190) is central to ensuring variable coverage.
    *   **Fetching:** [`fetch_variable_data()`](data/ground_truth_ingestion_manager.py:1113) acts as a dispatcher to specific API fetchers.
    *   **Daemon Control:** [`start_daemon()`](data/ground_truth_ingestion_manager.py:1705), [`stop_daemon()`](data/ground_truth_ingestion_manager.py:1760), [`check_status()`](data/ground_truth_ingestion_manager.py:1808).
    *   **Scheduling:** [`setup_scheduler()`](data/ground_truth_ingestion_manager.py:1477) configures jobs; [`update_market_data()`](data/ground_truth_ingestion_manager.py:1543) and [`update_economic_data()`](data/ground_truth_ingestion_manager.py:1590) are example job functions.

*   **Hardcoding Issues:**
    *   `API_COSTS`: ([`data/ground_truth_ingestion_manager.py:150`](data/ground_truth_ingestion_manager.py:150))
    *   `API_LIMITS`: ([`data/ground_truth_ingestion_manager.py:163`](data/ground_truth_ingestion_manager.py:163))
    *   `TOTAL_BUDGET` (default): ([`data/ground_truth_ingestion_manager.py:159`](data/ground_truth_ingestion_manager.py:159)) (CLI overridable)
    *   Fallback `VARIABLE_REGISTRY`: ([`data/ground_truth_ingestion_manager.py:96`](data/ground_truth_ingestion_manager.py:96))
    *   File paths for PID, state, logs, and dataset files are hardcoded relative to `DATASET_DIR`.
    *   `UPDATE_FREQUENCIES` for sources: ([`data/ground_truth_ingestion_manager.py:173`](data/ground_truth_ingestion_manager.py:173)) (though scheduler uses specific cron/interval triggers).
    *   Default country "US" in [`generate_enhanced_mappings()`](data/ground_truth_ingestion_manager.py:190) for World Bank.
    *   Default fallback series IDs/symbols in [`generate_enhanced_mappings()`](data/ground_truth_ingestion_manager.py:190).

*   **Coupling Points:**
    *   **`VARIABLE_REGISTRY` Structure:** Tightly coupled to its expected structure.
    *   **External API Formats:** Similar to `ground_truth_generator.py`.
    *   **`apscheduler` Library:** The daemonization and scheduling features are tightly coupled to `apscheduler`. If this library is unavailable, a significant portion of the module's functionality is disabled.
    *   **File-based State:** Relies on PID files, pickle files for scheduler state, and JSON files for mappings/budget, making it sensitive to file system access and integrity.

*   **Existing Tests:**
    *   No unit tests or integration tests are present within this module.
    *   Testing would be complex, involving mocking APIs, file system operations, `apscheduler` behavior, and process management.

*   **Module Architecture and Flow:**
    1.  **Initialization:** Sets up logging, loads API keys, defines constants, checks for `apscheduler`.
    2.  **Initial Setup ([`run_initial_setup()`](data/ground_truth_ingestion_manager.py:2002)):** Ensures directories and essential files (mappings, budget, README) exist.
    3.  **CLI Parsing ([`main()`](data/ground_truth_ingestion_manager.py:2037)):** Determines action (start, stop, status, force-update).
    4.  **Daemon Operations (if `start`):**
        *   Checks if already running.
        *   Loads budget tracking.
        *   Sets up scheduler ([`setup_scheduler()`](data/ground_truth_ingestion_manager.py:1477)) with jobs for data updates, metadata updates, and error monitoring.
        *   Starts scheduler, writes PID, registers cleanup.
        *   Enters a loop, periodically saving scheduler state.
    5.  **Force Update Operations (if `force-update`):**
        *   Loads budget, generates/loads mappings.
        *   Filters mappings by specified sources/variables.
        *   Fetches economic and market data.
        *   Updates metadata and README.
    6.  **Variable Mapping ([`generate_enhanced_mappings()`](data/ground_truth_ingestion_manager.py:190)):** Uses regex and pattern matching to map registry variables to data sources, aiming for full coverage.
    7.  **Data Fetching:** Similar to `ground_truth_generator.py`, with functions for each API, orchestrated by [`fetch_economic_data()`](data/ground_truth_ingestion_manager.py:1153) and [`fetch_market_data()`](data/ground_truth_ingestion_manager.py:1229). Data is merged with existing CSVs.
    8.  **Metadata/Documentation:** [`write_metadata()`](data/ground_truth_ingestion_manager.py:1305) and [`write_readme()`](data/ground_truth_ingestion_manager.py:1400) are called after updates.
    *   The architecture supports both one-off updates and continuous, scheduled operation as a daemon.

*   **Naming Conventions:**
    *   Generally follows PEP 8.
    *   Constants `UPPER_SNAKE_CASE`.
    *   Functions and variables `snake_case`.

## 6. Overall Assessment

*   **Completeness:** Very High. This module is significantly more comprehensive than `ground_truth_generator.py`, aiming for full automation, robust error handling, and operational management of the data ingestion pipeline. It addresses many aspects of a production-ready data ingestion system.
*   **Quality:** Good to Very Good.
    *   **Strengths:**
        *   Advanced variable mapping logic designed for completeness.
        *   Daemonization and scheduling capabilities are well-implemented (assuming `apscheduler` works as expected).
        *   Detailed logging, including separate logs for unmapped and error variables.
        *   Robust API interaction with rate limiting, cost tracking, and retries.
        *   Persistent state for budget and scheduler (though scheduler restore could be more explicit).
        *   CLI for operational control is well-designed.
        *   Good separation of concerns (fetching, mapping, scheduling, daemon logic).
    *   **Areas for Improvement:**
        *   Complete NASDAQ API integration.
        *   Externalize more configurations (API costs/limits, file paths if necessary).
        *   Enhance scheduler state restoration to actively re-establish jobs if the scheduler restarts, rather than just logging.
        *   The module is quite large (over 2000 lines). While well-structured, some parts (like the extensive `generate_enhanced_mappings` or the individual fetchers if they grow) could potentially be broken into smaller, more focused helper modules or classes if complexity increases further.
        *   Lack of automated tests is a significant gap for a module of this complexity and importance.

## 7. Summary Note for Main Report

The [`data/ground_truth_ingestion_manager.py`](data/ground_truth_ingestion_manager.py:1) module provides a robust and automated system for ingesting and maintaining ground truth financial data, featuring enhanced variable mapping, scheduled updates via `apscheduler` (if available), daemonization, comprehensive logging, and budget management. It significantly advances data pipeline automation but shares the pending NASDAQ API integration task with its generator counterpart and would benefit from externalized configurations and automated testing.