# Module Analysis: `dev_tools/pulse_ui_plot.py`

## 1. Module Intent/Purpose

The [`dev_tools/pulse_ui_plot.py`](dev_tools/pulse_ui_plot.py:1) module is designed as a command-line utility and a library for visualizing Pulse simulation data. Its primary functions are:

*   To load and plot the time-series data of one or more simulation variables from history log files (JSONL format).
*   To load and plot alignment scores from JSON or JSONL files.
*   To provide options for displaying plots directly or exporting them as PNG images.
*   To be usable both as a standalone CLI tool and as a library imported by other modules (like [`dev_tools/pulse_ui_bridge.py`](dev_tools/pulse_ui_bridge.py:1)).

## 2. Key Functionalities

*   **`load_variable_trace(file_path: str, var_names: List[str]) -> Dict[str, Tuple[List[int], List[float]]]`**:
    *   Reads a JSONL file specified by `file_path`.
    *   Extracts the values for each variable listed in `var_names` along with their corresponding simulation `step`.
    *   Handles file not found errors and malformed JSON lines gracefully by printing messages.
    *   Returns a dictionary where keys are variable names and values are tuples containing a list of steps and a list of values.
*   **`plot_variables(traces: Dict[str, Tuple[List[int], List[float]]], export_path: Optional[str] = None)`**:
    *   Takes the `traces` dictionary (output from [`load_variable_trace()`](dev_tools/pulse_ui_plot.py:20)).
    *   Uses `matplotlib.pyplot` to generate a line plot of the variables over simulation steps.
    *   Sets plot title, labels, grid, and legend.
    *   If `export_path` is provided, saves the plot as an image file. Otherwise, displays the plot.
    *   Handles errors during plot export.
*   **`plot_alignment_scores(path: str, path_out: Optional[str] = None, **kwargs)`**:
    *   Reads alignment scores from a JSON or JSONL file.
    *   Extracts `alignment_score` and `forecast_id` (or generates a default ID).
    *   Uses `matplotlib.pyplot` to generate a bar chart of alignment scores per forecast ID.
    *   Sets plot title, labels, and handles x-axis tick rotation for readability.
    *   If `path_out` (or `save_path` via `kwargs` for backward compatibility) is provided, saves the plot. Otherwise, displays it.
*   **`main()`**:
    *   Implements the command-line interface using `argparse`.
    *   Provides arguments for specifying input files (`--file`, `--alignment`), variables to plot (`--var`), and export paths (`--export`, `--save`).
    *   Calls the appropriate plotting function based on parsed arguments.
    *   Prints help if required arguments are missing.

## 3. Role Within `dev_tools/` Directory

This module serves as a dedicated utility for data visualization within the developer tools. Its role is to:

*   Provide a reusable way to inspect simulation variable trends and alignment scores.
*   Support both interactive analysis (displaying plots) and report generation (exporting plots).
*   Offer both a CLI for direct use and functions that can be imported and used by other tools, such as the [`dev_tools/pulse_ui_bridge.py`](dev_tools/pulse_ui_bridge.py:1) for GUI integration.

## 4. Dependencies

### Internal Pulse Modules:

*   None directly, though it's designed to process output files generated by other Pulse components.

### External Libraries:

*   `argparse`: For parsing command-line arguments.
*   `json`: For reading and parsing JSON/JSONL data files.
*   `os`: For path existence checks (`os.path.exists`).
*   `matplotlib.pyplot`: The core library used for generating plots.
*   `typing` (List, Tuple, Dict, Optional): For type hinting.

## 5. Adherence to SPARC Principles

*   **Module Intent/Purpose:**
    *   Clearly defined in the docstring and through its functionalities: "Pulse Variable Grapher CLI" for plotting simulation data. This aligns with simplicity and focused tasks.
*   **Operational Status/Completeness:**
    *   The module appears operational for its defined scope of plotting variable traces and alignment scores from specified file formats.
    *   It handles common issues like missing files and malformed data lines.
*   **Implementation Gaps / Unfinished Next Steps:**
    *   **Customization:** Plotting options (colors, line styles, more advanced `matplotlib` features) are largely hardcoded. More customization could be beneficial.
    *   **Error Handling in CLI:** The CLI prints error messages but doesn't use exit codes to signal failure, which can be important for scripting.
    *   **Input Data Schema:** Assumes specific structures for the input JSONL/JSON files (e.g., presence of "step", "variables", "alignment_score"). More robust validation or clearer documentation of expected schemas could be useful.
    *   **Testing:** No explicit tests for this module are visible within the file.
*   **Connections & Dependencies:**
    *   Primarily depends on `matplotlib` for plotting and standard libraries for file I/O and argument parsing.
    *   Designed to be loosely coupled with data-producing parts of Pulse, interacting via file interfaces.
*   **Function and Class Example Usages:**
    *   The CLI usage is shown in the module docstring:
        ```bash
        python pulse/tools/pulse_ui_plot.py --var hope --file history_logs/vars_run017.jsonl
        ```
    *   The [`main()`](dev_tools/pulse_ui_plot.py:120) function demonstrates how [`load_variable_trace()`](dev_tools/pulse_ui_plot.py:20), [`plot_variables()`](dev_tools/pulse_ui_plot.py:55), and [`plot_alignment_scores()`](dev_tools/pulse_ui_plot.py:85) are used based on CLI arguments.
*   **Hardcoding Issues:**
    *   Plot appearance details (figure size, titles, labels, colors for alignment plot) are hardcoded.
    *   Default forecast ID generation (`f"fc{i}"`) in [`plot_alignment_scores()`](dev_tools/pulse_ui_plot.py:85) if `forecast_id` is missing.
*   **Coupling Points:**
    *   Coupled to the `matplotlib.pyplot` API. Changes in this API could require updates.
    *   Implicitly coupled to the data format of the JSONL/JSON files it consumes.
*   **Existing Tests:**
    *   No tests for this module are present within the file itself.
*   **Module Architecture and Flow:**
    1.  Imports.
    2.  Data loading function ([`load_variable_trace()`](dev_tools/pulse_ui_plot.py:20)).
    3.  Plotting functions ([`plot_variables()`](dev_tools/pulse_ui_plot.py:55), [`plot_alignment_scores()`](dev_tools/pulse_ui_plot.py:85)).
    4.  [`main()`](dev_tools/pulse_ui_plot.py:120) function for CLI argument parsing and dispatching to appropriate functions.
    5.  Standard `if __name__ == "__main__":` block to run [`main()`](dev_tools/pulse_ui_plot.py:120).
    The architecture is straightforward, separating data loading, plotting logic, and CLI handling.
*   **Naming Conventions:**
    *   Module name (`pulse_ui_plot.py`) is descriptive.
    *   Function names are clear and follow snake_case.
    *   Variable names are generally clear.
    *   The CLI argument `--var` is a bit short but common; `--variables` might be slightly clearer. `--save` as an alias for saving alignment plots is distinct from `--export` for variable plots.

## 6. Overall Assessment

*   **Completeness:**
    *   The module is largely complete for its intended functionality of plotting variable traces and alignment scores from files.
    *   It provides both CLI and library interfaces.
*   **Quality:**
    *   **Strengths:**
        *   Clear separation of data loading and plotting logic.
        *   Robust handling of common file and data errors (missing files, malformed JSON lines).
        *   Provides useful visualizations for simulation analysis.
        *   Includes a functional CLI.
    *   **Areas for Improvement:**
        *   **Plot Customization:** Exposing more `matplotlib` customization options could enhance flexibility.
        *   **Error Reporting:** CLI could use exit codes. Library functions might benefit from raising specific exceptions rather than just printing to console for some error types, especially when used by other modules like the UI bridge.
        *   **Code Duplication:** Minor duplication in export logic (try-except block for `plt.savefig`) in [`plot_variables()`](dev_tools/pulse_ui_plot.py:55) and [`plot_alignment_scores()`](dev_tools/pulse_ui_plot.py:85). This could be refactored into a helper.
        *   **Modularity of Plotting:** The plotting functions directly call `plt.show()` or `plt.savefig()`. For better library use, they could return the `figure` object, allowing the caller to decide on showing/saving.

## 7. Note for Main Report

The `dev_tools/pulse_ui_plot.py` module offers a functional CLI and library for visualizing Pulse simulation variable trends and alignment scores using `matplotlib`, with good error handling for data loading, though plot customization is limited.