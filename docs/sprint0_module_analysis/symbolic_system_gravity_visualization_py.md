# Module Analysis: `symbolic_system/gravity/visualization.py`

## 1. Module Intent/Purpose

The primary role of [`symbolic_system/gravity/visualization.py`](../../symbolic_system/gravity/visualization.py) is to provide utilities for visualizing the "Symbolic Gravity Fabric" system. It aims to represent symbolic pillars and their interactions, offering both terminal-based ASCII art and graphical plots using Matplotlib.

## 2. Operational Status/Completeness

The module appears to be largely complete for its defined scope. It includes:
*   Functionality for ASCII visualization ([`generate_ascii_visualization()`](../../symbolic_system/gravity/visualization.py:40)).
*   Functionality for Matplotlib-based graphical visualization ([`plot_symbolic_pillars()`](../../symbolic_system/gravity/visualization.py:100)).
*   A high-level wrapper function ([`visualize_gravity_fabric()`](../../symbolic_system/gravity/visualization.py:305)) to select the visualization method.
*   Graceful fallback to ASCII if Matplotlib is not available ([`HAS_MATPLOTLIB`](../../symbolic_system/gravity/visualization.py:25)).
*   A command-line interface (CLI) for standalone execution and testing ([`if __name__ == "__main__":`](../../symbolic_system/gravity/visualization.py:398)).

No obvious TODOs or major placeholders are visible within the code.

## 3. Implementation Gaps / Unfinished Next Steps

*   **No Explicit Gaps for Current Scope:** The module fulfills its stated purpose of ASCII and Matplotlib visualization.
*   **Potential Future Extensions (Not Implied as Missing):**
    *   More sophisticated or interactive visualization types (e.g., web-based using libraries like Plotly/Bokeh, or 3D renderings) could be considered for future development but are not indicated as planned or incomplete.
    *   More configurable styling options for plots could be added.
*   **CLI Fallback Data:** The CLI's example data ([`symbolic_system/gravity/visualization.py:433-450`](../../symbolic_system/gravity/visualization.py:433)) is hardcoded, which is acceptable for a demonstration or fallback mechanism when the main `SymbolicPillarSystem` is not available.

## 4. Connections & Dependencies

### Direct Project Module Imports:
*   [`symbolic_system.gravity.symbolic_pillars.SymbolicPillarSystem`](../../symbolic_system/gravity/symbolic_pillars.py) (conditionally imported in CLI section)
*   [`symbolic_system.gravity.gravity_config.ResidualGravityConfig`](../../symbolic_system/gravity/gravity_config.py) (conditionally imported in CLI section)

### External Library Dependencies:
*   [`numpy`](https://numpy.org/) (as `np`)
*   [`logging`](https://docs.python.org/3/library/logging.html)
*   [`json`](https://docs.python.org/3/library/json.html)
*   [`os`](https://docs.python.org/3/library/os.html)
*   [`datetime`](https://docs.python.org/3/library/datetime.html) from `datetime`
*   `matplotlib.pyplot` (as `plt`, optional)
*   `matplotlib.colors` (as `mcolors`, optional)
*   `matplotlib.patches.Rectangle`, `matplotlib.patches.FancyArrowPatch` (optional)
*   [`argparse`](https://docs.python.org/3/library/argparse.html) (for CLI)

### Interactions via Shared Data:
*   The module primarily consumes data generated by [`SymbolicPillarSystem.generate_visualization_data()`](../../symbolic_system/gravity/visualization.py:331). This data is expected to be a dictionary containing:
    *   `pillars`: A list of dictionaries, each representing a pillar (e.g., with "name", "intensity", "height", "growth_indicator").
    *   `interactions`: A list of dictionaries for interactions (e.g., with "source", "target", "strength", "type").
    *   `fabric_metrics`: A dictionary of overall fabric metrics.
*   It can also load this data structure from a JSON file via its CLI.

### Input/Output Files:
*   **Input:**
    *   Optionally, a JSON file containing visualization data (via `--input` CLI argument).
*   **Output:**
    *   PNG image file: If Matplotlib is used and an output path is specified (via function argument `save_path` or CLI `--output`). Defaults to `symbolic_gravity_YYYYMMDD_HHMMSS.png` in the CWD if no path is given but Matplotlib output is chosen.
    *   Text file: If ASCII output is chosen and an output path is specified.
    *   JSON file: If JSON output is chosen and an output path is specified.
    *   Standard Output: Prints ASCII or JSON data if no output path is specified for these formats.

## 5. Function and Class Example Usages

*   **[`generate_ascii_visualization(pillar_data: List[Dict[str, Any]], max_height: int = 10) -> str`](../../symbolic_system/gravity/visualization.py:40):**
    *   Takes a list of pillar data dictionaries and an optional maximum height.
    *   Returns a string containing the ASCII art representation of the pillars.
    ```python
    # Example (conceptual)
    pillar_info = [{"name": "P1", "intensity": 0.8, "growth_indicator": 1}, {"name": "P2", "intensity": 0.4}]
    ascii_art = generate_ascii_visualization(pillar_info)
    print(ascii_art)
    ```

*   **[`plot_symbolic_pillars(pillar_data: List[Dict[str, Any]], interactions: Optional[List[Dict[str, Any]]] = None, ...) -> Optional[Any]`](../../symbolic_system/gravity/visualization.py:100):**
    *   Takes pillar data, optional interaction data, save path, title, and fabric metrics.
    *   Generates a Matplotlib figure. If `save_path` is provided, it saves the figure.
    *   Returns the Matplotlib figure object or `None` if Matplotlib is unavailable.
    ```python
    # Example (conceptual)
    # Assuming pillar_info and interaction_info are populated
    # and matplotlib is available
    # fig = plot_symbolic_pillars(pillar_info, interactions=interaction_info, save_path="pillars.png")
    ```

*   **[`visualize_gravity_fabric(pillar_system_or_data: Any, output_path: Optional[str] = None, format_type: str = "auto") -> str`](../../symbolic_system/gravity/visualization.py:305):**
    *   This is the main interface function. It accepts either a `SymbolicPillarSystem` instance or pre-formatted data.
    *   `format_type` can be "auto", "matplotlib", "ascii", or "json".
    *   It orchestrates the visualization generation and returns the path to the saved file or the ASCII/JSON string.
    ```python
    # Example (conceptual, using data)
    # data = get_visualization_data_from_system() # or load from JSON
    # result_path = visualize_gravity_fabric(data, output_path="fabric_viz.png", format_type="matplotlib")
    # print(f"Visualization saved to: {result_path}")

    # ascii_output = visualize_gravity_fabric(data, format_type="ascii")
    # print(ascii_output)
    ```
*   **CLI Usage:**
    The `if __name__ == "__main__":` block ([`symbolic_system/gravity/visualization.py:398-459`](../../symbolic_system/gravity/visualization.py:398)) demonstrates command-line usage:
    ```bash
    python symbolic_system/gravity/visualization.py --input data.json --output viz.png --format matplotlib
    python symbolic_system/gravity/visualization.py --output viz.txt --format ascii
    ```

## 6. Hardcoding Issues

Several parameters affecting the visual output are hardcoded:

*   **ASCII Visualization:**
    *   Default `max_height` is 10 ([`generate_ascii_visualization()`](../../symbolic_system/gravity/visualization.py:41)).
    *   Pillar width (e.g., `─` * 8, `█` * 8) is fixed.
*   **Matplotlib Visualization ([`plot_symbolic_pillars()`](../../symbolic_system/gravity/visualization.py:100)):**
    *   Pillar geometry: `pillar_width = 0.8`, `spacing = 1.0`.
    *   Default pillar height scaling: `intensity * 100` if "height" not in pillar data.
    *   Text label offsets and rotations (e.g., pillar name y-offset `-10`, rotation `45`).
    *   Arrow properties for interactions: `connectionstyle="arc3,rad=0.3"`.
    *   Line width scaling for interactions: `min(3.0, abs(strength) * 5)`.
    *   Colors for interaction types ("opposing": 'red', "enhancing": 'green', "neutral": 'gray').
    *   Font sizes for various text elements (e.g., 8, 9, 10, 12, 14).
    *   Y-coordinate for fabric schematic line: `fabric_y = -20`.
    *   Default output filename pattern if path not given: `symbolic_gravity_{timestamp}.png`.
*   **CLI Example Data:** The fallback data used in the CLI ([`symbolic_system/gravity/visualization.py:433-450`](../../symbolic_system/gravity/visualization.py:433)) is entirely hardcoded (pillar names, values, interactions). This is generally acceptable for example/fallback purposes.

While these hardcodings provide default behaviors, making some of them configurable (e.g., via a config object or function parameters) could enhance flexibility if needed.

## 7. Coupling Points

*   **Data Structure:** Tightly coupled to the expected dictionary structure for `pillar_data`, `interactions`, and `fabric_metrics`. Changes in this data structure from `SymbolicPillarSystem` would require updates here.
*   **Matplotlib:** Dependency on Matplotlib for graphical plotting. The module handles its absence by falling back to ASCII.
*   **Internal Project Imports (CLI):** The CLI section directly imports from [`symbolic_system.gravity.symbolic_pillars`](../../symbolic_system/gravity/symbolic_pillars.py:) and [`symbolic_system.gravity.gravity_config`](../../symbolic_system/gravity/gravity_config.py:).

## 8. Existing Tests

*   The provided file list includes `tests/symbolic_system/gravity/__init__.py` and `tests/symbolic_system/gravity/test_residual_gravity_engine.py`.
*   There is **no specific `test_visualization.py`** apparent in the file list.
*   This suggests a potential gap in dedicated unit tests for the visualization functionalities themselves (e.g., testing output generation for various inputs, handling of missing Matplotlib, CLI argument parsing). Some aspects might be indirectly covered in integration tests if these visualizations are generated and validated as part of a larger test suite.

## 9. Module Architecture and Flow

1.  **Optional Matplotlib Import:** The module first attempts to import Matplotlib and sets a flag [`HAS_MATPLOTLIB`](../../symbolic_system/gravity/visualization.py:25).
2.  **Core Visualization Functions:**
    *   [`generate_ascii_visualization()`](../../symbolic_system/gravity/visualization.py:40): Constructs an ASCII string representation.
    *   [`plot_symbolic_pillars()`](../../symbolic_system/gravity/visualization.py:100): Uses Matplotlib to create a graphical plot of pillars and interactions.
3.  **Main Orchestration Function:**
    *   [`visualize_gravity_fabric()`](../../symbolic_system/gravity/visualization.py:305):
        *   Accepts either a `SymbolicPillarSystem` object (from which it calls `.generate_visualization_data()`) or pre-structured data.
        *   Determines the output format (`matplotlib`, `ascii`, `json`) based on the `format_type` argument and `HAS_MATPLOTLIB` status.
        *   Calls the appropriate core visualization function.
        *   Handles saving to a file or returning the visualization as a string.
4.  **CLI Interface (`if __name__ == "__main__":`)** ([`symbolic_system/gravity/visualization.py:398`](../../symbolic_system/gravity/visualization.py:398)):
    *   Uses `argparse` to handle command-line arguments (`--input`, `--output`, `--format`).
    *   Loads data from an input JSON file or generates example data (either by attempting to use `SymbolicPillarSystem` or falling back to hardcoded data).
    *   Calls [`visualize_gravity_fabric()`](../../symbolic_system/gravity/visualization.py:305) with the data and arguments.
    *   Prints the result (path to saved file or visualization string).

## 10. Naming Conventions

*   The module generally adheres to PEP 8 naming conventions:
    *   `snake_case` for functions and variables (e.g., [`generate_ascii_visualization`](../../symbolic_system/gravity/visualization.py:40), `pillar_data`).
    *   Imported classes like `Rectangle` and `FancyArrowPatch` use `PascalCase`.
    *   Constants like [`HAS_MATPLOTLIB`](../../symbolic_system/gravity/visualization.py:25) are in `UPPER_SNAKE_CASE`.
*   Variable names are generally descriptive and clear (e.g., `x_positions`, `fabric_metrics`, `interaction_type`).
*   The author is tagged as "Pulse v3.5" ([`symbolic_system/gravity/visualization.py:10`](../../symbolic_system/gravity/visualization.py:10)).
*   No significant deviations or potential AI assumption errors in naming were observed.