# Module Analysis: `symbolic_system/symbolic_trace_scorer.py`

**Version:** `v0.022.1` (as per module docstring)
**Last Updated:** 2025-04-17 (as per module docstring)

## Module Intent/Purpose

The primary role of [`symbolic_system/symbolic_trace_scorer.py`](../../symbolic_system/symbolic_trace_scorer.py:2) is to score symbolic trace histories. This scoring is based on narrative coherence, symbolic instability (volatility), and emotional arc structure. The module is intended to be used by other components like PFPA, Strategos Tile Formatter, Forecast Summary Synthesis, and Symbolic Diagnostics.

## Operational Status/Completeness

The module appears to be operational and relatively complete for its defined scope. It has a clear function [`score_symbolic_trace()`](../../symbolic_system/symbolic_trace_scorer.py:35) that takes a trace and returns a set of scores and labels. It includes basic error handling for empty traces and logging functionality. There are no obvious placeholders or TODO comments in the provided code.

## Implementation Gaps / Unfinished Next Steps

*   **Sophistication of Arc Detection:** The current arc detection logic (e.g., "Hope Arc", "Fatigue Collapse") is based on simple trend direction and threshold checks (e.g., `max(hope_vals) > 0.7`). This could be expanded to recognize more nuanced or complex arc patterns. The "Neutral" arc is a default and doesn't capture much information.
*   **Symbolic Scope:** The scoring currently focuses on "hope", "fatigue", "rage", and "despair". The system might intend to incorporate a broader range of symbolic values or allow dynamic configuration of which symbols to score.
*   **Certainty Calculation:** The `arc_certainty` is derived directly from volatility. More sophisticated certainty measures could be developed, potentially incorporating the strength or clarity of the trend, or consistency across multiple symbols.
*   **Configurable Thresholds:** Values like `0.7` for arc detection or `0.25` for "Symbolic Whiplash" are hardcoded. These could be made configurable.

## Connections & Dependencies

*   **Direct Imports (Project Modules):** None explicitly shown in the provided snippet, but its output is used by other (unseen) project modules as stated in its description (PFPA, Strategos Tile Formatter, etc.).
*   **External Library Dependencies:**
    *   `json`: Used for logging results in JSONL format.
    *   `os`: Used for ensuring the log directory exists ([`ensure_log_dir()`](../../symbolic_system/symbolic_trace_scorer.py:32)).
    *   `typing`: Used for type hints (`List`, `Dict`).
    *   `datetime`: Used for timestamping log entries.
*   **Interaction via Shared Data:**
    *   **Output Log File:** Writes scoring results to [`logs/symbolic_trace_scores.jsonl`](../../logs/symbolic_trace_scores.jsonl). This file acts as an interface for other processes that might consume these scores.
*   **Input/Output Files:**
    *   **Input:** Takes a list of dictionaries representing symbolic overlays per turn. This data structure is likely generated by another part of the system.
    *   **Output:** Produces a dictionary containing `symbolic_score`, `arc_label`, `volatility_score`, and `arc_certainty`. Writes to [`logs/symbolic_trace_scores.jsonl`](../../logs/symbolic_trace_scores.jsonl).

## Function and Class Example Usages

The module contains one primary function:

*   **[`score_symbolic_trace(trace: List[Dict[str, float]]) -> Dict`](../../symbolic_system/symbolic_trace_scorer.py:35):**
    *   **Purpose:** Calculates scores for a given symbolic trace.
    *   **Usage Example (from module's `if __name__ == "__main__":` block):**
        ```python
        example_trace = [
            {"hope": 0.5, "fatigue": 0.4, "rage": 0.3, "despair": 0.6},
            {"hope": 0.55, "fatigue": 0.42, "rage": 0.32, "despair": 0.52},
            {"hope": 0.68, "fatigue": 0.38, "rage": 0.34, "despair": 0.42},
            {"hope": 0.78, "fatigue": 0.35, "rage": 0.33, "despair": 0.28}
        ]
        score = score_symbolic_trace(example_trace)
        print("Arc:", score["arc_label"], "| Symbolic Score:", score["symbolic_score"])
        ```

## Hardcoding Issues

*   **Log Path:** [`SCORE_LOG_PATH = "logs/symbolic_trace_scores.jsonl"`](../../symbolic_system/symbolic_trace_scorer.py:30) is hardcoded. This should ideally be configurable, perhaps via a configuration file or environment variable.
*   **Default Symbol Values:** If a symbol (e.g., "hope") is missing from a turn in the trace, it defaults to `0.5` (e.g., `t.get("hope", 0.5)`). This default value might not be appropriate for all symbols or scenarios.
*   **Arc Detection Thresholds:**
    *   `0.7` for `max(hope_vals)` and `max(fatigue_vals)` in arc determination ([`symbolic_system/symbolic_trace_scorer.py:68-71`](../../symbolic_system/symbolic_trace_scorer.py:68-71)).
    *   `0.25` for `volatility` to trigger "Symbolic Whiplash" ([`symbolic_system/symbolic_trace_scorer.py:72-73`](../../symbolic_system/symbolic_trace_scorer.py:72-73)).
    *   `0.6` (initial despair) and `0.4` (final despair) for "Recovery Arc" ([`symbolic_system/symbolic_trace_scorer.py:74-75`](../../symbolic_system/symbolic_trace_scorer.py:74-75)).
*   **Volatility Multipliers for Scores:**
    *   `volatility * 1.2` for `symbolic_score` ([`symbolic_system/symbolic_trace_scorer.py:77`](../../symbolic_system/symbolic_trace_scorer.py:77)).
    *   `volatility * 2.0` for `arc_certainty` ([`symbolic_system/symbolic_trace_scorer.py:78`](../../symbolic_system/symbolic_trace_scorer.py:78)).
*   **Symbol Keys:** The names of the symbols ("hope", "fatigue", "rage", "despair") are hardcoded strings when extracting values from the trace.
*   **Metadata Version:** The version `"v0.022.1"` is hardcoded in the result metadata ([`symbolic_system/symbolic_trace_scorer.py:88`](../../symbolic_system/symbolic_trace_scorer.py:88)). This should ideally be dynamically linked to the module's actual version or a global project version.

## Coupling Points

*   **Input Data Structure:** Tightly coupled to the input `trace` structure, expecting a `List[Dict[str, float]]` where each dictionary contains specific keys like "hope", "fatigue", etc. Changes to this data structure in upstream modules would break this scorer.
*   **Output Log File:** [`logs/symbolic_trace_scores.jsonl`](../../logs/symbolic_trace_scores.jsonl) serves as a coupling point. Any other module consuming this log file depends on its format and content.
*   **Consumers of Output Dictionary:** The structure of the dictionary returned by [`score_symbolic_trace()`](../../symbolic_system/symbolic_trace_scorer.py:35) (keys like `symbolic_score`, `arc_label`) is a contract with consuming modules (PFPA, Strategos Tile Formatter, etc.).

## Existing Tests

*   **Test File:** Based on the `list_files` result for `tests/symbolic_system/`, there does not appear to be a dedicated test file named `test_symbolic_trace_scorer.py`. There is a `tests/symbolic_system/gravity/` subdirectory and a `tests/symbolic_system/__init__.py`, but no direct test for this module.
*   **Inline Example:** The module includes an `if __name__ == "__main__":` block ([`symbolic_system/symbolic_trace_scorer.py:102`](../../symbolic_system/symbolic_trace_scorer.py:102)) which provides a basic example usage. This is not a substitute for a formal test suite but offers a minimal check.
*   **Coverage & Gaps:** Without dedicated tests, coverage is likely zero or minimal (only what the inline example covers). Obvious gaps include testing:
    *   Edge cases (empty trace, single-turn trace).
    *   Traces designed to trigger each specific arc label.
    *   Traces with missing symbolic keys.
    *   Volatility calculations with various inputs.
    *   Log file creation and writing.

## Module Architecture and Flow

1.  **Initialization:**
    *   The [`ensure_log_dir()`](../../symbolic_system/symbolic_trace_scorer.py:32) function is called to create the log directory if it doesn't exist.
2.  **Input Validation:**
    *   Checks if the input `trace` is empty. If so, returns a default dictionary with zero scores and "Empty" arc label.
3.  **Data Extraction:**
    *   Extracts lists of values for "hope", "fatigue", "rage", and "despair" from the trace, defaulting to `0.5` if a key is missing.
4.  **Volatility Calculation:**
    *   The helper function [`delta_avg()`](../../symbolic_system/symbolic_trace_scorer.py:54) calculates the average absolute change between consecutive values in a list.
    *   Overall `volatility` is the average of the `delta_avg` for the four tracked symbols.
5.  **Arc Label Determination:**
    *   The helper function [`trend_direction()`](../../symbolic_system/symbolic_trace_scorer.py:57) determines if a list of values is trending "up" or "down".
    *   A series of `if/elif` conditions check trends and max values of symbols, or overall volatility, to assign an `arc_label` (e.g., "Hope Arc", "Fatigue Collapse", "Symbolic Whiplash", "Recovery Arc", or "Neutral").
6.  **Score Calculation:**
    *   `symbolic_score` is calculated as `1.0 - min(volatility * 1.2, 1.0)`.
    *   `arc_certainty` is calculated as `1.0 - min(volatility * 2.0, 1.0)`.
7.  **Result Assembly:**
    *   A dictionary `result` is created containing the calculated scores, arc label, number of turns, a UTC timestamp, and metadata (version, source file).
8.  **Logging:**
    *   The `result` dictionary is serialized to JSON and appended to [`SCORE_LOG_PATH`](../../symbolic_system/symbolic_trace_scorer.py:30) ([`logs/symbolic_trace_scores.jsonl`](../../logs/symbolic_trace_scores.jsonl)).
    *   Includes basic error handling for logging.
9.  **Return Value:**
    *   The `result` dictionary is returned.

## Naming Conventions

*   **Functions:** [`score_symbolic_trace`](../../symbolic_system/symbolic_trace_scorer.py:35), [`ensure_log_dir`](../../symbolic_system/symbolic_trace_scorer.py:32), [`delta_avg`](../../symbolic_system/symbolic_trace_scorer.py:54), [`trend_direction`](../../symbolic_system/symbolic_trace_scorer.py:57) follow PEP 8 (snake_case).
*   **Variables:** Generally follow PEP 8 (e.g., `hope_vals`, `symbolic_score`, `arc_label`).
*   **Constants:** [`SCORE_LOG_PATH`](../../symbolic_system/symbolic_trace_scorer.py:30) is in uppercase, which is conventional for constants.
*   **Clarity:** Names are generally clear and descriptive.
*   **Potential AI Assumption Errors/Deviations:**
    *   The module header indicates "Author: Pulse AI Engine". The code quality is reasonable for an AI-generated module, but the hardcoding issues and lack of dedicated tests are typical areas where AI might cut corners without explicit instructions for robustness and configurability.
    *   The logic for arc determination is simplistic and rule-based, which might be an initial scaffold generated by an AI that could be improved with more sophisticated pattern recognition.