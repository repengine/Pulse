# Module Analysis: `learning/trust_audit.py`

## 1. Module Intent/Purpose

The primary role of the [`learning/trust_audit.py`](learning/trust_audit.py:1) module is to perform a strategic audit of recent foresight memory, specifically focusing on forecast data. It aims to:

*   Summarize the distribution of forecasts across different trust bands ("游릭 Trusted", "丘멆잺 Moderate", "游댮 Fragile") based on confidence scores.
*   Calculate and report average values for key forecast metrics: confidence, fragility, retrodiction score, priority score, and age (in hours).
*   Identify potential integrity issues within the trust loop by detecting inconsistencies, such as highly trusted forecasts exhibiting low retrodiction or high fragility, or fragile forecasts showing high confidence.
*   Serve as a strategic checkpoint, likely executed after simulation runs, to provide an overview of the reliability and health of the system's forecasting capabilities.

## 2. Operational Status/Completeness

*   The module appears largely functional for its defined scope, particularly the core logic within the [`audit_forecasts()`](learning/trust_audit.py:62) and [`trust_loop_integrity_issues()`](learning/trust_audit.py:32) functions.
*   It handles potentially missing keys in forecast data by using default values (e.g., `f.get("confidence", 0)`).
*   It correctly processes both individual and "compressed" forecasts (those containing an "examples" list of sub-forecasts).
*   A notable point of incompleteness is the function [`audit_trust()`](learning/trust_audit.py:58), which is defined but only contains a logging statement indicating its start. It does not perform any actual audit operations, suggesting it might be a placeholder for future, more comprehensive audit functionalities or an intended entry point that was not fully developed.

## 3. Implementation Gaps / Unfinished Next Steps

*   **`audit_trust()` Function:** The [`audit_trust()`](learning/trust_audit.py:58) function is a significant gap, as it's currently a stub. It could have been intended to orchestrate various types of trust audits or provide a more detailed overall trust assessment.
*   **Persistent Audit Results:** The module outputs its findings only via logging. There's no mechanism for storing audit results persistently (e.g., in a database, CSV, or structured log file), which would be beneficial for trend analysis and historical review.
*   **Structured Reporting:** Reports are console-based log messages. Generating structured reports (e.g., JSON, HTML) could improve usability and integration with other tools.
*   **Alerting:** No integration with an alerting system for critical trust issues.
*   **Advanced Analysis:** The current analysis is a snapshot. Future enhancements could include trend analysis of trust metrics over time or more sophisticated anomaly detection in forecast quality.
*   **Configuration of Thresholds:** Several thresholds for defining trust bands and integrity issues are hardcoded (see Section 6).

## 4. Connections & Dependencies

*   **Direct Project Module Imports:**
    *   [`forecast_output.pfpa_logger`](forecast_output/pfpa_logger.py:1): Specifically, [`get_latest_forecasts()`](forecast_output/pfpa_logger.py:1) (and `PFPA_ARCHIVE`, though unused) for sourcing forecast data.
    *   [`utils.log_utils`](utils/log_utils.py:1): For [`get_logger()`](utils/log_utils.py:1) to instantiate a logger.
    *   [`core.pulse_config`](core/pulse_config.py:1): Imports `CONFIDENCE_THRESHOLD` and `MODULES_ENABLED`, although these specific imports are not directly utilized in the logic flow of the current code.
*   **External Library Dependencies:**
    *   `statistics`: For the [`mean()`](https://docs.python.org/3/library/statistics.html#statistics.mean) function.
*   **Interaction via Shared Data:**
    *   Reads forecast data structures (dictionaries) that are expected to be produced by other system components (e.g., simulation or forecasting engines) and made available via the `pfpa_logger` mechanism. The schema of these forecast objects (keys like `confidence`, `fragility_score`, `retrodiction_score`, etc.) is a critical interface.
*   **Input/Output Files:**
    *   **Input:** Relies on [`get_latest_forecasts()`](forecast_output/pfpa_logger.py:1) to provide forecast data, which likely reads from files managed by the `pfpa_logger` system. The specific file paths are abstracted.
    *   **Output:** All output is directed to the system logger. No dedicated files are generated by this module.

## 5. Function and Class Example Usages

*   **`trust_band(trace)` ([`learning/trust_audit.py:22`](learning/trust_audit.py:22))**
    *   Description: Categorizes a forecast trace into a trust band based on its confidence score.
    *   Example:
        ```python
        trace1 = {"confidence": 0.8}
        print(trust_band(trace1))  # Output: "游릭 Trusted"

        trace2 = {"confidence": 0.55}
        print(trust_band(trace2))  # Output: "丘멆잺 Moderate"
        ```

*   **`trust_loop_integrity_issues(forecasts)` ([`learning/trust_audit.py:32`](learning/trust_audit.py:32))**
    *   Description: Analyzes a list of forecasts to detect and report inconsistencies between trust labels, confidence, retrodiction, and fragility.
    *   Example:
        ```python
        forecast_list = [
            {"trace_id": "FC001", "trust_label": "游릭 Trusted", "confidence": 0.9, "retrodiction_score": 0.4, "fragility": 0.1},
            {"trace_id": "FC002", "trust_label": "游댮 Fragile", "confidence": 0.8, "retrodiction_score": 0.9, "fragility": 0.2}
        ]
        issues = trust_loop_integrity_issues(forecast_list)
        for issue in issues:
            print(issue)
        # Output:
        # 丘멆잺 Trusted forecast FC001 has low retrodiction (0.4)
        # 丘멆잺 Fragile forecast FC002 has high confidence (0.8)
        ```

*   **`audit_forecasts(memory=None, recent_n: int = 10)` ([`learning/trust_audit.py:62`](learning/trust_audit.py:62))**
    *   Description: Main audit function. Gathers forecasts, computes statistics, logs a report, and checks for trust loop integrity issues.
    *   Example:
        ```python
        # Audit the 15 most recent forecasts (output will be logged)
        # audit_forecasts(recent_n=15)

        # Audit a provided list of forecast objects
        # custom_forecasts = [...] # list of forecast dictionaries
        # audit_forecasts(memory=custom_forecasts)
        ```

## 6. Hardcoding Issues

*   **Trust Band Thresholds:** In [`trust_band()`](learning/trust_audit.py:22), confidence thresholds `0.75` and `0.5` are hardcoded.
*   **Integrity Check Thresholds:** In [`trust_loop_integrity_issues()`](learning/trust_audit.py:32):
    *   Low retrodiction: `retro < 0.5` ([`learning/trust_audit.py:47`](learning/trust_audit.py:47))
    *   High fragility: `frag > 0.7` ([`learning/trust_audit.py:50`](learning/trust_audit.py:50))
    *   High confidence (for fragile forecasts): `conf > 0.7` ([`learning/trust_audit.py:53`](learning/trust_audit.py:53))
*   **Trust Band Labels:** Strings like `"游릭 Trusted"`, `"丘멆잺 Moderate"`, `"游댮 Fragile"` are hardcoded.
*   **Default `recent_n`:** The default value for `recent_n` in [`audit_forecasts()`](learning/trust_audit.py:62) is `10`.
*   **Default Values in `.get()`:**
    *   `f.get("retrodiction_score", 1.0)` ([`learning/trust_audit.py:43`](learning/trust_audit.py:43)) vs. `f.get("retrodiction_score", 0)` ([`learning/trust_audit.py:92`](learning/trust_audit.py:92)) shows an inconsistency in default assumptions for `retrodiction_score`.

## 7. Coupling Points

*   **Forecast Data Structure:** Highly coupled to the specific keys and structure of forecast dictionaries (e.g., `confidence`, `fragility_score`, `retrodiction_score`, `examples`). Changes to this schema in data producers would break this module.
*   **`forecast_output.pfpa_logger` ([`forecast_output/pfpa_logger.py`](forecast_output/pfpa_logger.py:1)):** Direct dependency for sourcing forecast data.
*   **`core.pulse_config` ([`core/pulse_config.py`](core/pulse_config.py:1)):** For configuration values, though currently imported values are not actively used to alter logic.
*   **`utils.log_utils` ([`utils/log_utils.py`](utils/log_utils.py:1)):** For the logging mechanism.

## 8. Existing Tests

*   No specific test file (e.g., `tests/learning/test_trust_audit.py`) is apparent in the provided file listing.
*   The module contains a `if __name__ == "__main__": audit_forecasts()` ([`learning/trust_audit.py:124`](learning/trust_audit.py:124)) block, allowing for direct script execution, which can serve for basic manual testing or demonstration. However, this does not replace automated unit or integration tests.
*   The absence of dedicated tests suggests a potential gap in test coverage for this module.

## 9. Module Architecture and Flow

1.  The main entry point is [`audit_forecasts()`](learning/trust_audit.py:62).
2.  Forecast data is retrieved either from the `memory` parameter or by calling [`get_latest_forecasts()`](forecast_output/pfpa_logger.py:1).
3.  The code handles "compressed" forecasts by iterating through their `examples` field, treating each example as an individual forecast.
4.  For each forecast:
    *   [`trust_band()`](learning/trust_audit.py:22) is called to categorize it based on its `confidence`.
    *   Relevant metrics (confidence, fragility, retrodiction, priority, age) are collected.
5.  Aggregate statistics are calculated:
    *   Counts for each trust band.
    *   Mean values for the collected metrics.
    *   Maximum age.
6.  These statistics are logged.
7.  [`trust_loop_integrity_issues()`](learning/trust_audit.py:32) is called with all processed forecasts. This function checks for predefined inconsistent states (e.g., trusted forecast with low retrodiction).
8.  Any detected integrity issues are logged, or a success message is logged if no issues are found.
9.  The [`audit_trust()`](learning/trust_audit.py:58) function is present but currently non-operational beyond a log message.

## 10. Naming Conventions

*   Function and variable names (e.g., [`trust_band()`](learning/trust_audit.py:22), [`avg_conf`](learning/trust_audit.py:100)) generally adhere to PEP 8 (snake_case).
*   Imported constants (`PFPA_ARCHIVE`, `CONFIDENCE_THRESHOLD`) are uppercase.
*   The use of emojis in trust band string literals (e.g., `"游릭 Trusted"`) is a stylistic choice for log output.
*   There's a slight inconsistency in fetching fragility metrics: `f.get("fragility", f.get("fragility_score", 0))` ([`learning/trust_audit.py:42`](learning/trust_audit.py:42)) suggests `fragility_score` is preferred but `fragility` is a fallback, or vice-versa. Standardizing on one key name would be clearer.
*   Overall, naming is clear and consistent with Python conventions.